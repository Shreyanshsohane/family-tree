<html>
  <head>
    <script src="/lineage.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>

    <link rel="stylesheet" href="./lineage.min.css" />
  </head>
  <body>
    <div id="divFamily"></div>
    <div id="test"></div>
    <script src="lineage.min.js"></script>
    <script>
      // var jsonData = [];
      var params = {};
      let outputArr = [];

      let finalOutput = [];
      let uniqueObjects = {};
      var jsonData = [];
      var input = [
        {
          spouseId: 5,
          user: {
            id: 1,
            name: "Father Doe",
            gender: "male",
          },
        },
        {
          spouseId: 1,
          user: {
            id: 5,
            name: "Mommy Doe",
            gender: "female",
          },
        },
        {
          parentId: 1,
          spouseId: 6,
          user: {
            id: 2,
            name: "Jane Doe",
            gender: "female",
          },
        },
        {
          parentId: 1,
          user: {
            id: 3,
            name: "Kane Doe",
            gender: "male",
          },
        },
        {
          parentId: 2,

          user: {
            id: 4,
            name: "Jane's Daughter",
            gender: "female",
          },
        },
        {
          parentId: 6,

          user: {
            id: 4,
            name: "Jane's Daughter",
            gender: "female",
          },
        },
        {
          parentId: 5,
          spouseId: 6,
          user: {
            id: 2,
            name: "Jane Doe",
            gender: "female",
          },
        },
        {
          parentId: 5,
          user: {
            id: 3,
            name: "Kane Doe",
            gender: "male",
          },
        },
        {
          spouseId: 2,
          user: {
            id: 6,
            name: "Test Doe",
            gender: "male",
          },
        },
      ];

      async function genderFinder(id) {
        console.log("id received", id);
        for (let j = 0; j < input.length; j++) {
          if (input[j].user.id == id) {
            console.log("Indisde gender", input[j].user.gender);
            return input[j].user.gender;
          }
        }
        return "male";
      }

      async function findExistingMember(id) {
        for (let k = 0; k < outputArr.length; k++) {
          console.log("OUtside check", outputArr[k]);
          console.log("ID", id);
          if (outputArr[k].id == id) {
            console.log("Inside check", outputArr[k]);
            return outputArr[k];
          }
        }
        return 0;
      }
      async function check() {
        for (let i = 0; i < input.length; i++) {
          let member = input[i];
          let existFinder = await findExistingMember(member.user.id);

          var templateMember;
          let template = {
            //   id: undefined,
            //   fid: undefined,
            //   mid: undefined,
            //   pid: undefined,
            addr: "",
            name: "",
            photo: "",
            title: "Title",
            gender: "",
          };

          console.log("Exist finder 123", existFinder);
          if (existFinder == 0) {
            console.log("Template", template);
            templateMember = template;
          } else {
            console.log("Template retreived", existFinder);
            templateMember = existFinder;
          }

          console.log("Exist finder 456", existFinder);
          templateMember.id = member.user.id;
          templateMember.name = member.user.name;
          templateMember.gender = member.user.gender;
          if (member.spouseId) {
            templateMember.pid = member.spouseId;
          }
          if (member.parentId) {
            let genderResult = await genderFinder(member.parentId);
            if (genderResult == "male") {
              templateMember.fid = member.parentId;
              console.log("Father case", member.parentId, templateMember);
            } else {
              templateMember.mid = member.parentId;
              console.log("Mother case", member.parentId, templateMember);
            }
          }
          console.log("MEmber one", templateMember);
          outputArr.push(templateMember);
        }
        return outputArr;
      }

      const paramsMeter = new URLSearchParams(window.location.search);
      console.log("Tpken", paramsMeter.get("token"));
      const ele = document.getElementById("test");
      ele.innerHTML = paramsMeter.get("token");
      console.log("Params", paramsMeter);

      // Function to make the GET request and return a promise with the response data
      function fetchData() {
        var token =
          "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6NTQsImlhdCI6MTY4ODY1MjIyMSwiZXhwIjoxNjkxMjQ0MjIxfQ.VDKrXaCJFlcvqA_R9BQyBrrCaSuEaH3SJoSDQZHBdVw";

        var headers = {
          Authorization: "Bearer " + token,
        };

        return fetch("http://localhost:1337/api/relation/tree", { headers })
          .then((response) => response.json())
          .then((data) => {
            console.log("Data,", data);
            // jsonData = data.data.attributes.family;

            check().then((data) => {
              console.log("Entered params", data);
              data.forEach((obj) => {
                if (!uniqueObjects[obj.id]) {
                  uniqueObjects[obj.id] = true;
                  finalOutput.push(obj);
                }
              });
              console.log("Check", finalOutput);
              loadFamilyTree();
            });
          })
          .catch((error) => {
            console.log("Error:", error);
          });
      }

      // Function to load the family tree with the updated data
      function loadFamilyTree() {
        var params = {
          data: finalOutput,
          search: false,
          container: "divFamily",
          template: "rounded",
        };
        console.log("Formation started", params);
        var tree = new Lineage(params);
        tree.load();
      }

      console.log("Start of script");

      if (finalOutput.length == 0) {
        fetchData();
      } else {
        console.log("JSOn", jsonData);
        loadFamilyTree();
      }
    </script>
  </body>
</html>
